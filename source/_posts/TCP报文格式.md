---
title: TCP报文格式
date: 2019-06-20 13:36:16
tags: 
- 网络
- tcp
categories: 面试必会
header_image: /intro/internet.jpg
---

# 什么是TCP

TCP 是一种安全的网络传输协议, 它安全可靠.  当包丢失时, 具有重传机制

​	如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据（假设丢失了）将会被重传。

优点: 可靠

缺点: 首部过大, 速度相比与UDP慢一些

## TCP报文格式

![](/Blog/intro/tcp.jpeg)



### 源端口号 (Source Port) & 目的端口号 (Destination Port)

源端口 和 目的端口 分别占用 2 字节, 分别包含发送端的端口号和目的主机的端口号

TCP 和 UDP 都不包含 ip 地址信息, 因为那是ip层的工作

但是 TCP 和 UDP 都会有源端口和目的端口 (端口号可以唯一标识主机中的一个进程)

这样, 我们可以通过 **ip地址 + 协议 + 端口号** 来标识 ***网络中*** 唯一的进程

这种标识也被称作 **socket**, 即套接字



### 序号   (Sequence Number)

**简写(seq)** 占用4个字节

Sequence Number 非常重要,  TCP中传输的每个都按顺序进行编号



例如: 

一段报文的 Sequence Number 为67, 而携带的数据有100个字段

如果有下一段报文, 那么报文的 Sequence Number 就会为(67+100), 从167开始



### 确认号   (Acknowledgement Number)

**简写(ack)** 同样占用4个字节

ack 代表 期望对方相应报文的第一个序号 (Sequence Number)



例如: 

A 向 B 发送一段报文, seq为51, 携带 300 个字段

B 正确收到了到 seq= 350 (51+300-1)为止的数据, 因此 B 期望收到A的下一个报文的seq为351

所以B再发送给A的确认报文中 ack = 501



### 数据偏移／首部长度(offset)

由于TCP头部有可选字段, 长度不固定. 

因此它会指出 TCP 报文的数据, 距离 TCP报文的起始有多远



### 保留

为将来定义新的用途保留，现在置为0



### TCP Flags

主要由8个标志位组成

常用6个:

- URG：紧急指针标志，为1时, 表示指针有效, 为0则忽略紧急指针；
- **ACK**：确认序号标志，多数情况下空，说明确认序号有效；
- PSH：推标志位，置位时表示接收方应立即请求将报文交给应用层, 而不是在缓冲区排队；
- RST：复位标志，用于重建一个已经混乱的连接；
- **SYN**：同步标志，该标志仅在三次握手建立TCP连接时有效, 用于建立连接过程;
- **FIN**：结束标志，带该标志位的数据包用于结束一个TCP会话, 释放连接;



### 窗口 window

滑动窗口大小，用来告知发送端接受端的缓存大小, 以此控制发送端发送数据的速率, 从而达到流量控制

由于它是占用2个字节(16bits), 所以窗口大小最大为65535



### 校验和 checksum

奇偶校验，此校验和是对整个的 TCP 报文段，包括 TCP 头部和 TCP 数据，以 16 位字进行计算所得。由发送端计算和存储，并由接收端进行验证。



### 紧急指针 Urgent Pointer

只有当 TCP Flags 中 URG 标志置 1 时紧急指针才有效. 

紧急指针是一个正的偏移量，和顺序号字段中的值相加表示紧急数据最后一个字节的序号。 

TCP 的紧急方式是发送端向另一端发送紧急数据的一种方式。



### 可选项 TCP Options

长度可变, 定义一些可选参数

最常见的可选字段是最长报文大小，又称为MSS (Maximum Segment Size) , 它表示本端所能接受的最大报文段的长度。

选项长度不一定是32位的整数倍，所以要加填充位，即在这个字段中加入额外的零，以保证TCP头是32的整数倍。



# 结尾:

下一篇将会通过抓包来分析TCP的三次握手, 期间会反复使用ack, seq 等相关知识



参考资料:

https://www.cnblogs.com/feng9exe/p/8058891.html

https://blog.51cto.com/lyhbwwk/2162568

慕课网: 剑指Java面试